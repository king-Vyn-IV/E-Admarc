{% extends 'base.html' %}
{% load static %}
{% load humanize %}
{% block title %}Fresh Marketplace | E-ADMARC{% endblock %}

{% block content %}
<div class="container-fluid py-5 bg-light">
  <div class="container">

    <!-- Header -->
    <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center mb-5">
      <div>
        <h1 class="fw-bold text-success mb-1">
          <i class="bi bi-person-circle me-2"></i>Welcome, {{ request.user.username }}
        </h1>
        <p class="text-muted mb-0">
          <i class="bi bi-geo-alt me-1"></i>Explore the marketplace and manage your submissions
        </p>
      </div>

      <!-- Search & Filter -->
      <div class="d-flex flex-column flex-sm-row align-items-sm-center gap-3 mt-3 mt-lg-0">
        <form class="d-flex gap-2" method="get">
          <div class="position-relative">
            <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
            <input type="text" name="q" value="{{ request.GET.q }}" class="form-control ps-5 rounded-pill shadow-sm" placeholder="Search"/>
          </div>
          <select class="form-select rounded-pill shadow-sm" name="filter">
            <option value="" {% if not request.GET.filter %}selected{% endif %}>All time</option>
            <option value="7" {% if request.GET.filter == '7' %}selected{% endif %}>Last 7 days</option>
            <option value="30" {% if request.GET.filter == '30' %}selected{% endif %}>Last 30 days</option>
            <option value="90" {% if request.GET.filter == '90' %}selected{% endif %}>Last 90 days</option>
          </select>
          <button type="submit" class="btn btn-outline-success rounded-circle shadow-sm">
            <i class="bi bi-arrow-clockwise"></i>
          </button>
        </form>
        
        <a href="{% url 'cart' %}" class="btn btn-outline-secondary rounded-circle shadow-sm position-relative">
          <i class="bi bi-cart3"></i>
          {% if total_cart_items %}
          <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger">
            {{ total_cart_items }}
          </span>
          {% endif %}
        </a>
      </div>
    </div>

    <!-- Marketplace Products -->
    <h3 class="mb-3">Marketplace Products</h3>
    <div class="row g-4 mb-5">
      {% for product in products %}
      <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
        <div class="card border-0 shadow-sm rounded-4 h-100">
          {% if product.image %}
          <img src="{{ product.image.url }}" class="card-img-top rounded-top-4" alt="{{ product.name }}">
          {% else %}
          <img src="{% static 'images/default-product.png' %}" class="card-img-top rounded-top-4" alt="{{ product.name }}">
          {% endif %}
          <div class="card-body d-flex flex-column">
            <h5 class="card-title fw-bold">{{ product.name }}</h5>
            <p class="text-muted mb-1"><i class="bi bi-box-seam me-1"></i>{{ product.quantity }} Kgs available</p>
            <p class="fw-bold">MWK {{ product.price|intcomma }} /Kg</p>
            <p class="text-muted mb-1"><i class="bi bi-person-fill me-1"></i>{{ product.user.username }}</p>
            <p class="text-muted mb-1"><i class="bi bi-tag-fill me-1"></i>{{ product.category }}</p>
            <p class="card-text line-clamp-2">{{ product.description }}</p>
            <small class="text-muted mt-auto">Submitted {{ product.submitted_at|naturaltime }}</small>

            <!-- Add to Cart button -->
            <button 
                class="btn btn-success add-to-cart-btn"  
                data-url="{% url 'add_to_cart' product.id %}">
                <i class="bi bi-cart-plus me-1"></i>Add to Cart
            </button>
          </div>
        </div>
      </div>
      {% empty %}
      <p class="text-center text-muted">No products found.</p>
      {% endfor %}
    </div>

    <!-- User’s Own Submissions -->
    {% if user_submissions %}
    <h3 class="mb-3">Your Submissions</h3>
    <div class="row g-4">
      {% for submission in user_submissions %}
      <div class="col-12 col-sm-6 col-lg-4 col-xl-3">
        <div class="card border-0 shadow-sm rounded-4 h-100 d-flex flex-column">
          {% if submission.image %}
          <img src="{{ submission.image.url }}" class="card-img-top rounded-top-4" alt="{{ submission.name }}">
          {% else %}
          <img src="{% static 'images/default-product.png' %}" class="card-img-top rounded-top-4" alt="{{ submission.name }}">
          {% endif %}
          <div class="card-body d-flex flex-column flex-grow-1">
            <h5 class="card-title fw-bold">{{ submission.name }}</h5>
            <p class="text-muted mb-1"><i class="bi bi-tag-fill me-1"></i>{{ submission.category }}</p>
            <p class="text-muted mb-1"><i class="bi bi-box-seam me-1"></i>{{ submission.quantity }}Kgs</p>
            <p class="fw-bold">MWK {{ submission.price|intcomma }}</p>
            <p class="card-text line-clamp-2">{{ submission.description }}</p>
            <small class="text-muted mt-auto">Status: <strong>{{ submission.status }}</strong></small>
            <small class="text-muted">Submitted {{ submission.submitted_at|naturaltime }}</small>
          </div>
          <div class="card-footer bg-transparent border-0 d-flex justify-content-between pt-2">
            <a href="{% url 'submission_edit' submission.id %}" class="btn btn-sm btn-primary rounded-pill">
              <i class="bi bi-pencil-fill me-1"></i>Edit
            </a>
            <form method="post" action="{% url 'submission_delete' submission.id %}" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this submission?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-danger rounded-pill">
                <i class="bi bi-trash-fill me-1"></i>Delete
              </button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}

  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const buttons = document.querySelectorAll('.add-to-cart-btn');

  buttons.forEach(button => {
    button.addEventListener('click', async () => {
      const url = button.getAttribute('data-url');

      try {
        const response = await fetch(url, {
          method: 'POST',
          headers: {
            'X-CSRFToken': getCookie('csrftoken'),
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({ quantity: 1 })
        });

        // Check for redirect (unauthenticated user)
        if (response.redirected) {
          window.location.href = response.url;
          return;
        }

        const data = await response.json();

        if (data.success) {
          alert('✅ Product added to cart!');

          // Update cart badge
          const cartBadge = document.getElementById('cart-badge');
          if (cartBadge) {
            cartBadge.textContent = data.cart_count || 1;
            cartBadge.style.display = 'inline-block';
          }
        } else {
          alert(`❌ Failed to add to cart: ${data.error || 'Unknown error'}`);
        }

      } catch (error) {
        console.error('Add to cart error:', error);
        alert('❌ An unexpected error occurred.');
      }
    });
  });

  // Helper: Get CSRF token from cookies
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>

{% endblock %}
